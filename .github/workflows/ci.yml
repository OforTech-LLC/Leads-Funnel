# =============================================================================
# Continuous Integration
# =============================================================================
# Runs on all PRs and pushes - tests, linting, and build verification
# =============================================================================

name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '22'
  SWIFT_VERSION: '6.2'

jobs:
  # ===========================================================================
  # Frontend CI
  # ===========================================================================
  frontend-lint:
    name: Frontend Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build shared package
        run: npm run build --workspace=@kanjona/shared

      - name: Run ESLint (web)
        working-directory: apps/web
        run: npm run lint

      - name: Type check web
        working-directory: apps/web
        run: npx tsc --noEmit

      - name: Type check admin
        run: npm run type-check --workspace=@leads-funnel/admin

      - name: Type check portal
        run: npm run type-check --workspace=@leads-funnel/portal

  frontend-build:
    name: Frontend Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build shared package
        run: npm run build --workspace=@kanjona/shared

      - name: Build web
        working-directory: apps/web
        run: npm run build
        env:
          CSRF_SECRET: "build-time-secret-for-ci"

      - name: Build admin
        run: npm run build --workspace=@leads-funnel/admin

      - name: Build portal
        run: npm run build --workspace=@leads-funnel/portal

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: apps/web/out
          retention-days: 1

  # ===========================================================================
  # Backend CI
  # ===========================================================================
  backend-test:
    name: Backend Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Swift
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: ${{ env.SWIFT_VERSION }}

      - name: Cache Swift packages
        uses: actions/cache@v4
        with:
          path: backend/.build
          key: ${{ runner.os }}-swiftpkg-v2-${{ hashFiles('backend/Package.swift') }}
          restore-keys: |
            ${{ runner.os }}-swiftpkg-v2-

      - name: Build
        working-directory: backend
        run: swift build

      - name: Run Tests
        working-directory: backend
        run: swift test --parallel

  api-test:
    name: TypeScript API Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build shared package
        run: npm run build --workspace=@kanjona/shared

      - name: Run TypeScript API tests
        run: npm run test:run --workspace=@leads-funnel/api
        env:
          EMAIL_HASH_SALT: test-salt-for-ci
          CURSOR_SECRET: test-cursor-secret-for-ci
          IP_HASH_SALT: test-ip-salt-for-ci

  # ===========================================================================
  # Terraform CI
  # ===========================================================================
  terraform-validate:
    name: Terraform Validate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.7.0'

      - name: Format Check
        working-directory: infra/terraform
        run: terraform fmt -check -recursive

      - name: Validate Dev
        working-directory: infra/terraform/envs/dev
        run: |
          terraform init -backend=false
          terraform validate

      - name: Validate Prod
        working-directory: infra/terraform/envs/prod
        run: |
          terraform init -backend=false
          terraform validate

  # ===========================================================================
  # Security Checks
  # ===========================================================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'
          ignore-unfixed: true

  # ===========================================================================
  # All Checks Summary
  # ===========================================================================
  ci-complete:
    name: CI Complete
    needs: [frontend-lint, frontend-build, backend-test, api-test, terraform-validate, security-scan]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Check all jobs
        run: |
          if [ "${{ needs.frontend-lint.result }}" != "success" ] || \
             [ "${{ needs.frontend-build.result }}" != "success" ] || \
             [ "${{ needs.backend-test.result }}" != "success" ] || \
             [ "${{ needs.api-test.result }}" != "success" ] || \
             [ "${{ needs.terraform-validate.result }}" != "success" ] || \
             [ "${{ needs.security-scan.result }}" != "success" ]; then
            echo "One or more CI checks failed"
            exit 1
          fi
          echo "All CI checks passed!"

      - name: Post Summary
        run: |
          echo "## CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend Lint | ${{ needs.frontend-lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend Build | ${{ needs.frontend-build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend Tests | ${{ needs.backend-test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| API Tests | ${{ needs.api-test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Terraform Validate | ${{ needs.terraform-validate.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
