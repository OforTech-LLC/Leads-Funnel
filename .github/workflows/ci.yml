# =============================================================================
# Continuous Integration
# =============================================================================
# Runs on all PRs and pushes - tests, linting, and build verification
# Path-based filtering skips irrelevant jobs for faster CI cycles.
# =============================================================================

name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '22'
  SWIFT_VERSION: '6.2'
  HUSKY: '0'

jobs:
  # ===========================================================================
  # Detect Changed Paths (enables per-job filtering)
  # ===========================================================================
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.filter.outputs.frontend }}
      backend: ${{ steps.filter.outputs.backend }}
      terraform: ${{ steps.filter.outputs.terraform }}
      api: ${{ steps.filter.outputs.api }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect changed paths
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            frontend:
              - 'apps/web/**'
              - 'apps/admin/**'
              - 'apps/portal/**'
              - 'packages/shared/**'
              - 'package.json'
              - 'package-lock.json'
            backend:
              - 'backend/**'
            terraform:
              - 'infra/terraform/**'
            api:
              - 'apps/api/**'
              - 'packages/shared/**'
              - 'package.json'
              - 'package-lock.json'

  # ===========================================================================
  # Frontend CI
  # ===========================================================================
  frontend-lint:
    name: Frontend Lint
    needs: changes
    if: needs.changes.outputs.frontend == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Cache shared package
        id: shared-cache
        uses: actions/cache@v4
        with:
          path: packages/shared/dist
          key: ${{ runner.os }}-shared-${{ hashFiles('packages/shared/src/**') }}

      - name: Build shared package
        if: steps.shared-cache.outputs.cache-hit != 'true'
        run: npm run build --workspace=@kanjona/shared

      - name: Run ESLint (web)
        working-directory: apps/web
        run: npm run lint

      - name: Type check web
        working-directory: apps/web
        run: npx tsc --noEmit

      - name: Type check admin
        run: npm run type-check --workspace=@leads-funnel/admin

      - name: Type check portal
        run: npm run type-check --workspace=@leads-funnel/portal

  frontend-build:
    name: Frontend Build
    needs: changes
    if: needs.changes.outputs.frontend == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Cache shared package
        id: shared-cache
        uses: actions/cache@v4
        with:
          path: packages/shared/dist
          key: ${{ runner.os }}-shared-${{ hashFiles('packages/shared/src/**') }}

      - name: Build shared package
        if: steps.shared-cache.outputs.cache-hit != 'true'
        run: npm run build --workspace=@kanjona/shared

      - name: Cache Next.js build
        uses: actions/cache@v4
        with:
          path: apps/web/.next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('package-lock.json') }}-${{ hashFiles('apps/web/src/**') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('package-lock.json') }}-
            ${{ runner.os }}-nextjs-

      - name: Build web
        working-directory: apps/web
        run: npm run build
        env:
          CSRF_SECRET: "build-time-secret-for-ci"

      - name: Build admin
        run: npm run build --workspace=@leads-funnel/admin

      - name: Build portal
        run: npm run build --workspace=@leads-funnel/portal

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: apps/web/out
          retention-days: 1

  # ===========================================================================
  # Backend CI
  # ===========================================================================
  backend-test:
    name: Backend Tests
    needs: changes
    if: needs.changes.outputs.backend == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache Swift toolchain
        id: swift-toolchain
        uses: actions/cache@v4
        with:
          path: /opt/hostedtoolcache/swift-Ubuntu
          key: ${{ runner.os }}-swift-toolchain-${{ env.SWIFT_VERSION }}

      - name: Setup Swift
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: ${{ env.SWIFT_VERSION }}

      - name: Cache Swift packages
        uses: actions/cache@v4
        with:
          path: backend/.build
          key: ${{ runner.os }}-swiftpkg-v2-${{ hashFiles('backend/Package.swift') }}
          restore-keys: |
            ${{ runner.os }}-swiftpkg-v2-

      - name: Build
        working-directory: backend
        run: swift build

      - name: Run Tests
        working-directory: backend
        run: swift test --parallel

  api-test:
    name: TypeScript API Tests
    needs: changes
    if: needs.changes.outputs.api == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Cache shared package
        id: shared-cache
        uses: actions/cache@v4
        with:
          path: packages/shared/dist
          key: ${{ runner.os }}-shared-${{ hashFiles('packages/shared/src/**') }}

      - name: Build shared package
        if: steps.shared-cache.outputs.cache-hit != 'true'
        run: npm run build --workspace=@kanjona/shared

      - name: Run TypeScript API tests
        run: npm run test:run --workspace=@leads-funnel/api
        env:
          EMAIL_HASH_SALT: test-salt-for-ci
          CURSOR_SECRET: test-cursor-secret-for-ci
          IP_HASH_SALT: test-ip-salt-for-ci

  # ===========================================================================
  # Terraform CI
  # ===========================================================================
  terraform-validate:
    name: Terraform Validate
    needs: changes
    if: needs.changes.outputs.terraform == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.7.0'

      - name: Format Check
        working-directory: infra/terraform
        run: terraform fmt -check -recursive

      - name: Validate Dev
        working-directory: infra/terraform/envs/dev
        run: |
          terraform init -backend=false
          terraform validate

      - name: Validate Prod
        working-directory: infra/terraform/envs/prod
        run: |
          terraform init -backend=false
          terraform validate

  # ===========================================================================
  # Security Checks (always runs)
  # ===========================================================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'
          ignore-unfixed: true

  # ===========================================================================
  # All Checks Summary
  # ===========================================================================
  ci-complete:
    name: CI Complete
    needs: [changes, frontend-lint, frontend-build, backend-test, api-test, terraform-validate, security-scan]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Check all jobs
        run: |
          results=(
            "${{ needs.frontend-lint.result }}"
            "${{ needs.frontend-build.result }}"
            "${{ needs.backend-test.result }}"
            "${{ needs.api-test.result }}"
            "${{ needs.terraform-validate.result }}"
            "${{ needs.security-scan.result }}"
          )
          for result in "${results[@]}"; do
            if [ "$result" == "failure" ] || [ "$result" == "cancelled" ]; then
              echo "One or more CI checks failed: $result"
              exit 1
            fi
          done
          echo "All CI checks passed!"

      - name: Post Summary
        run: |
          echo "## CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend Lint | ${{ needs.frontend-lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend Build | ${{ needs.frontend-build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend Tests | ${{ needs.backend-test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| API Tests | ${{ needs.api-test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Terraform Validate | ${{ needs.terraform-validate.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ needs.security-scan.result }} |" >> $GITHUB_STEP_SUMMARY
